<script>

let numero = localStorage.getItem("numeroYikun") || 3281;
numero = parseInt(numero);

function formatoARS(valor){
    return valor.toLocaleString("es-AR", {
        style:"currency",
        currency:"ARS"
    });
}

function agregarFila(){
    let tabla = document.getElementById("tabla");
    let fila = tabla.insertRow();
    fila.innerHTML = `
    <td><input type="text" class="detalle"></td>
    <td><input type="number" class="cantidad" min="1"></td>
    <td><input type="number" class="precio" min="0" step="0.01"></td>
    `;
}

function generar(){

    let cliente = document.getElementById("cliente").value.trim();
    if(cliente === ""){
        alert("Ingresá el nombre del cliente.");
        return;
    }

    let detalles = document.getElementsByClassName("detalle");
    let cantidades = document.getElementsByClassName("cantidad");
    let precios = document.getElementsByClassName("precio");

    let totalPedido = 0;
    let filas = "";

    for(let i=0;i<detalles.length;i++){
        if(detalles[i].value !== ""){

            let cant = parseFloat(cantidades[i].value || 0);
            let precio = parseFloat(precios[i].value || 0);
            let subtotal = cant * precio;

            totalPedido += subtotal;

            filas += `
            <tr>
                <td>${detalles[i].value}</td>
                <td>${cant}</td>
                <td>${formatoARS(precio)}</td>
            </tr>`;
        }
    }

    if(totalPedido === 0){
        alert("Agregá al menos un producto.");
        return;
    }

    let sena = parseFloat(document.getElementById("sena").value || 0);
    let porcentaje = parseFloat(document.getElementById("descuento").value);
    let metodoPago = document.getElementById("pago").value;

    let montoDescuento = totalPedido * (porcentaje / 100);
    let totalFinal = totalPedido - montoDescuento;
    let pendiente = totalFinal - sena;

    if(pendiente < 0) pendiente = 0;

    let fechaActual = new Date().toLocaleDateString("es-AR");
    let numeroFormateado = numero.toString().padStart(6,'0');

    let vendedorSeleccionado = document.getElementById("vendedor").value;
    let datosVendedor = "";

    if(vendedorSeleccionado === "03"){
        datosVendedor = `
        Vendedor: 03 Lucas A. Grafica<br>
        Ayacucho 1621 - Salta Capital<br>
        Cel: 3875729428
        `;
    }

    if(vendedorSeleccionado === "02"){
        datosVendedor = `
        Vendedor: 02 Analia A. Papeleria<br>
        Ayacucho 1621 - Salta Capital<br>
        Cel: 3872254054
        `;
    }

    let contenido = `
    <div style="padding:20px; font-family:Arial;">

        <div style="text-align:center;">
            <img src="logo.png" style="max-width:150px;">
        </div>

        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span>Recibo B - ${numeroFormateado}</span>
            <span>${fechaActual}</span>
        </div>

        <br>

        <strong>Cliente:</strong> ${cliente}<br>
        ${datosVendedor}

        <br>

        <table style="width:100%; border-collapse:collapse;" border="1">
            <tr>
                <th>Detalle</th>
                <th>Cantidad</th>
                <th>Precio Unit.</th>
            </tr>
            ${filas}
        </table>

        <br>

        <strong>Total Pedido:</strong> ${formatoARS(totalPedido)}<br>
        <strong>Descuento (${porcentaje}%):</strong> ${formatoARS(montoDescuento)}<br>
        <strong>Total Final:</strong> ${formatoARS(totalFinal)}<br>
        <strong>Seña:</strong> ${formatoARS(sena)}<br>
        <strong>Pendiente:</strong> ${formatoARS(pendiente)}<br>
        <strong>Método de Pago:</strong> ${metodoPago}

    </div>
    `;

    let printArea = document.createElement("div");
    printArea.innerHTML = contenido + contenido; // duplica para 2 por hoja

    html2pdf().from(printArea).set({
        margin:0,
        filename:Recibo_${numeroFormateado}.pdf,
        html2canvas:{scale:2},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    }).save();

    numero++;
    localStorage.setItem("numeroYikun", numero);
}

</script>
