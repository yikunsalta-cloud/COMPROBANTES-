<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Comprobantes</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>

body{
    font-family: Arial, Helvetica, sans-serif;
    background:#f4f4f4;
    margin:0;
    padding:20px;
}

.formulario{
    background:white;
    padding:20px;
    border-radius:8px;
    max-width:600px;
    margin:auto;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

h2{
    text-align:center;
}

input, select{
    width:100%;
    padding:8px;
    margin-bottom:12px;
    border:1px solid #ccc;
    border-radius:4px;
}

button{
    background:#1f2937;
    color:white;
    border:none;
    padding:10px;
    width:100%;
    border-radius:4px;
    cursor:pointer;
}

button:hover{
    background:#111827;
}

.print-area{
    display:none;
}

.recibo{
    width:148mm;
    height:210mm;
    border:1px solid #000;
    padding:15mm;
    box-sizing:border-box;
    background:white;
}

.logo{
    display:block;
    margin:auto;
    max-width:150px;
}

.header-recibo{
    display:flex;
    justify-content:space-between;
    margin-top:10px;
    font-weight:bold;
}

.total{
    margin-top:20px;
    text-align:right;
    font-size:18px;
    font-weight:bold;
}

.tabla{
    margin-top:40px;
    background:white;
    padding:20px;
    border-radius:8px;
}

table{
    width:100%;
    border-collapse:collapse;
}

th, td{
    border:1px solid #ddd;
    padding:8px;
    text-align:center;
}

th{
    background:#1f2937;
    color:white;
}

</style>
</head>

<body>

<div class="formulario">
<h2>Generar Comprobante</h2>

<label>Fecha</label>
<input type="date" id="fecha">

<label>Cliente</label>
<input type="text" id="cliente">

<label>Vendedor</label>
<select id="vendedor">
<option>Juan</option>
<option>María</option>
<option>Pedro</option>
</select>

<label>Detalle</label>
<input type="text" id="detalle">

<label>Importe</label>
<input type="number" id="importe">

<label>Descuento</label>
<select id="descuento">
<option value="0">Sin descuento</option>
<option value="5">5%</option>
<option value="10">10%</option>
<option value="15">15%</option>
</select>

<label>Método de Pago</label>
<select id="pago">
<option>Efectivo</option>
<option>Transferencia</option>
</select>

<button onclick="generar()">Generar y Guardar PDF</button>

</div>

<div class="tabla">
<h2>Listado de Comprobantes</h2>
<table>
<thead>
<tr>
<th>N°</th>
<th>Fecha</th>
<th>Cliente</th>
<th>Total</th>
<th>Pago</th>
<th>Acción</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>
</div>

<div id="printArea" class="print-area"></div>

<script>

// ===== Numeración correlativa =====
let numeroActual = localStorage.getItem("numeroRecibo") || 1;
numeroActual = parseInt(numeroActual);

// ===== Historial =====
let historial = JSON.parse(localStorage.getItem("historialRecibos")) || [];

function guardarHistorial(){
    localStorage.setItem("historialRecibos", JSON.stringify(historial));
    renderHistorial();
}

function renderHistorial(){
    let tabla = document.getElementById("historial");
    tabla.innerHTML = "";

    historial.forEach((recibo, index)=>{
        tabla.innerHTML += `
        <tr>
        <td>${recibo.numero}</td>
        <td>${recibo.fecha}</td>
        <td>${recibo.cliente}</td>
        <td>$${recibo.total}</td>
        <td>${recibo.pago}</td>
        <td>
        <button onclick="descargar(${index})">PDF</button>
        <button onclick="eliminar(${index})">X</button>
        </td>
        </tr>
        `;
    });
}

function eliminar(index){
    historial.splice(index,1);
    guardarHistorial();
}

function descargar(index){
    generarPDF(historial[index]);
}

function generar(){

let fecha = document.getElementById("fecha").value;
let cliente = document.getElementById("cliente").value;
let vendedor = document.getElementById("vendedor").value;
let detalle = document.getElementById("detalle").value;
let importe = parseFloat(document.getElementById("importe").value);
let descuento = parseFloat(document.getElementById("descuento").value);
let pago = document.getElementById("pago").value;

let descuentoCalculado = (importe * descuento) / 100;
let total = (importe - descuentoCalculado).toFixed(2);

let numeroFormateado = numeroActual.toString().padStart(4,'0');

let recibo = {
numero: numeroFormateado,
fecha,
cliente,
vendedor,
detalle,
importe,
descuento,
pago,
total
};

historial.push(recibo);
guardarHistorial();

generarPDF(recibo);

numeroActual++;
localStorage.setItem("numeroRecibo", numeroActual);

}

function generarPDF(data){

let contenido = `
<div class="recibo">
<img src="Logo.png" class="logo">
<div class="header-recibo">
<span>Comprobante N° ${data.numero}</span>
<span>${data.fecha}</span>
</div>
<p><strong>Cliente:</strong> ${data.cliente}</p>
<p><strong>Vendedor:</strong> ${data.vendedor}</p>
<p><strong>Detalle:</strong> ${data.detalle}</p>
<p><strong>Método de Pago:</strong> ${data.pago}</p>
<p><strong>Total:</strong> $${data.total}</p>
</div>
`;

document.getElementById("printArea").innerHTML = contenido + contenido;

html2pdf().from(document.getElementById("printArea")).set({
margin:10,
filename:Recibo_${data.numero}.pdf,
html2canvas:{scale:2},
jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
}).save();

}

renderHistorial();

</script>

</body>
</html>
