<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Yikun - Comprobantes</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* ===== NUEVA DISTRIBUCIÓN COMPROBANTE ===== */

.header-comprobante{
    display:flex;
    justify-content:flex-end;
    margin-bottom:15px;
}

.header-derecha{
    text-align:right;
    font-size:14px;
}

.footer-comprobante{
    display:flex;
    justify-content:space-between;
    margin-top:25px;
}

.footer-izquierda{
    width:50%;
    font-size:14px;
}

.footer-derecha{
    width:40%;
    text-align:right;
    font-size:14px;
}

.saldo-rojo{
    margin-top:10px;
    font-size:22px;
    font-weight:bold;
    color:#FA551D;
}
</style>
    
</head>

<body>

<div class="header">
    <img src="logo.png">
</div>

<div class="container">

<!-- PANEL -->
<div class="panel">

<h3>Datos del Cliente</h3>

Cliente
<input id="cliente">

Vendedor
<select id="vendedor">
<option value="03">03 Lucas A.Grafica</option>
<option value="02">02 Analia A.Papeleria</option>
</select>

Forma de pago
<select id="formaPago">
<option>Efectivo</option>
<option>Transferencia</option>
<option>Tarjeta</option>
</select>

Seña
<input type="number" id="sena" value="0">

Descuento %
<input type="number" id="descuento" value="0">

<button class="btn-accion" onclick="generar()">GENERAR COMPROBANTE</button>
<button class="btn-accion" onclick="guardarPDF()">GUARDAR PDF</button>

</div>

<!-- PRODUCTOS -->
<div class="tabla-container">

<h3>Productos</h3>

<table id="tabla">
<tr>
<th>Detalle</th>
<th>Cantidad</th>
<th>Precio</th>
</tr>

<tr>
<td><input class="detalle"></td>
<td><input class="cantidad" type="number" value="1"></td>
<td><input class="precio" type="number" value="0"></td>
</tr>
</table>

<button class="btn-agregar" onclick="agregarFila()">AGREGAR PRODUCTO</button>

</div>

</div>

<div id="resultado"></div>

<script>

/* NUMERACION */
let numero = localStorage.getItem("numeroYikun");
if(!numero){ numero = 1; } else { numero = parseInt(numero); }

/* FORMATO */
function formatoARS(num){
    return "$ " + num.toLocaleString("es-AR");
}

/* AGREGAR PRODUCTO */
function agregarFila(){
    let tabla = document.getElementById("tabla");
    let fila = tabla.insertRow();
    fila.innerHTML = `
        <td><input class="detalle"></td>
        <td><input class="cantidad" type="number" value="1"></td>
        <td><input class="precio" type="number" value="0"></td>
    `;
}

/* GENERAR */
function generar(){

    let cliente = document.getElementById("cliente").value.trim();
    if(cliente===""){ alert("Ingrese nombre del cliente"); return; }

    let detalles = document.getElementsByClassName("detalle");
    let cantidades = document.getElementsByClassName("cantidad");
    let precios = document.getElementsByClassName("precio");

    let totalPedido = 0;
    let filas = "";

    for(let i=0;i<detalles.length;i++){
        if(detalles[i].value!==""){
            let cant = parseFloat(cantidades[i].value || 0);
            let precio = parseFloat(precios[i].value || 0);
            totalPedido += cant * precio;

            filas += `
            <tr>
                <td>${detalles[i].value}</td>
                <td>${cant}</td>
                <td>${formatoARS(precio)}</td>
            </tr>`;
        }
    }

    if(totalPedido===0){ alert("Agregue productos"); return; }

    let sena = parseFloat(document.getElementById("sena").value || 0);
    let porcentaje = parseFloat(document.getElementById("descuento").value || 0);
    let descuento = totalPedido*(porcentaje/100);
    let totalFinal = totalPedido-descuento;
    let pendiente = totalFinal-sena;
    if(pendiente<0) pendiente=0;

    let fecha = new Date().toLocaleDateString("es-AR");
    let numeroFormateado = numero.toString().padStart(6,'0');

    let comprobanteHTML="";

    for(let i=0;i<2;i++){

      comprobanteHTML+=`
<div class="comprobante">

    <img src="logo.png" class="logo-comprobante">

    <div class="header-comprobante">
        <div class="header-derecha">
            <div><strong>Fecha:</strong> ${fecha}</div>
            <div><strong>Recibo B:</strong> ${numeroFormateado}</div>
            <div><strong>Cliente:</strong> ${cliente}</div>
            <div><strong>Vendedor:</strong> ${nombreVendedor}</div>
        </div>
    </div>

    <table>
        <tr>
            <th>Detalle</th>
            <th>Cantidad</th>
            <th>Precio</th>
        </tr>
        ${filas}
    </table>

    <div class="footer-comprobante">
        
        <div class="footer-izquierda">
            <div>Total Pedido: ${formatoARS(totalPedido)}</div>
            <div>Descuento: ${formatoARS(descuento)}</div>
            <div>Seña: ${formatoARS(sena)}</div>
            <div class="saldo-rojo">
                Saldo Pendiente: ${formatoARS(pendiente)}
            </div>
        </div>

        <div class="footer-derecha">
            <div><strong>Datos del Vendedor</strong></div>
            <div>Local: Salta Capital</div>
            <div>Ayacucho 1621</div>
            <div>Tel: 3875XXXXXX</div>
        </div>

    </div>

</div>
`;

    document.getElementById("resultado").innerHTML = comprobanteHTML;

    numero++;
    localStorage.setItem("numeroYikun",numero);
}

/* PDF */
function guardarPDF(){
    const elemento=document.getElementById("resultado");

    var opt={
        margin:5,
        filename:'Comprobante_Yikun.pdf',
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    };

    html2pdf().set(opt).from(elemento).save();
}

</script>

</body>
</html>
